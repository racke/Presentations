<?xml version="1.0" encoding="ISO-8859-1"?>
<article id="paper-10190">
  <articleinfo>
    <title>Courier-Mailserver</title>
    <author>
      <firstname>Stefan</firstname>
      <surname>Hornburg</surname>
    </author>
    <copyright>
      <year>2004</year>
      <holder>Stefan Hornburg</holder>
    </copyright>
  </articleinfo>

<section>
  <title>Courier-Mailserver</title>
	<para>
	  Der Courier-Mailserver ist eine integrierte und zugleich
	  modulare Mail- und Groupwarelösung, die sich zunehmender
	  Beliebtheit erfreut.
    </para>
	<para id="framework">
	  Das Courier-Framework stellt den einzelnen Komponenten die folgenden
	  Funktionalitäten zur Verfügung:
    </para>
	<itemizedlist>
	  <listitem><para>Postfächer im <link linkend="maildir">Maildir++-Format</link></para></listitem>
	  <listitem><para>virtuelle Postfächer</para></listitem>
	  <listitem><para><link linkend="sharedfolders">gemeinsame Ordner</link></para></listitem>
	  <listitem><para><link linkend="auth">Authentifizierung</link> mittels eines speziellen
	  Dienstes</para></listitem>
	  <listitem><para><link linkend="ssl">SSL/TLS</link></para></listitem>
	  <listitem><para>Unterstützung von IPv6</para></listitem>
	 </itemizedlist>
	<para>
	  Courier entstand aus verschiedenen Projekten von Sam Varshavchik,
	  der auch heute noch den größten Anteil an der Weiterentwicklung
	  dieser Software hat.
	</para>
</section>

<section>
	<title>Pro und Contra</title>
	<para>
	  Courier zeichnet sich dadurch aus, das es sowohl als umfassendes
	  Paket aus Maildiensten verwendet werden kann als auch
	  in Kombinationen von verschiedenen Softwarepaketen, z.B.
	  mit Exim oder Postfix als SMTP-Server.
	</para>
	<para>
	  Ein weiterer wichtiger Pluspunkt ist die kontinuierliche
	  Weiterentwicklung und der umfangreiche Support auf den
	  Mailinglisten vom Autor und anderen Interessierten.
	</para>	
	<para>
	  Für den Einsatz von Courier ist eine gewisse Einarbeitung erforderlich,
	  zumal die Standardkonfiguration nicht für den typischen Kundenkreis
	  eines ISP geeignet ist. Dazu sind einige Einstellungen wie die maximale
	  Anzahl der Verbindungen pro IP beim IMAP-Server und der Umgang mit nicht
	  MIME-konformer Email zu konservativ.
	</para>
</section>

<section>
	<title>Komponenten im Überblick</title>
	<para>
	  Der Courier-Mailserver setzt sich aus den folgenden Komponenten zusammen:
	</para>
	 <itemizedlist>
		<listitem><para>SMTP-Server (Courier)</para></listitem>
		<listitem><para>IMAP-Server (Courier-IMAP)</para></listitem>
		<listitem><para>POP3-Server (Courier-POP)</para></listitem>
		<listitem><para>Webmail (SqWebMail)</para></listitem>
		<listitem><para>Mailinglisten-Server (couriermlm)</para></listitem>
		<listitem><para>MDA mit Filterfähigkeiten (Maildrop)</para></listitem>
		<listitem><para>Webadministration (courierwebadmin)</para></listitem>
	  </itemizedlist>
	<para>
	  Neben dem kompletten Quellpaket sind auch ausgewählte Komponenten
	  als gesonderte Distributionen erhältlich. Dies sind Courier-IMAP,
	  SqWebMail und Maildrop. Allerdings bestehen mitunter subtile Unterschiede
	  zwischen den aus dem Gesamtpaket erstellten Kompilaten und den
	  Einzelpaketen.
	</para>
</section>

<section id="maildir">
	<title>Maildir++</title>
	<para>Courier benutzt das sogenannte Maildir++-Format zur Speicherung und
	  zum Zugriff auf Emails. Dabei werden die einzelnen Emails in einer
	  Hierarchie von Verzeichnisse abgelegt. Die Vorteile dieses Verfahrens
	  gegenüber Mailboxdateien sind geringerer Resourcenbedarf, keine
	  Lockingprobleme (auch wenn sich die Postfächer auf einem NFS-Dateisystem
	  befinden) und gleichzeitiger 
	  Lese- und Schreibzugriff durch mehrere Mailclients.
	</para>
	<para>
	  Maildir++ erweitert das durch qmail eingeführten
	  <ulink url="http://www.qmail.org/man/man5/maildir.html">Maildir-Format</ulink>
	  um Ordner und 
	  Platzbeschränkungen (Quota) unabhängig vom Dateisystem.
	</para>
	<para>
	  Mailboxdateien werden zwar z.T. unterstützt,
	  z.B. für die Auslieferung von Emails durch Maildrop, empfehlenswert ist
	  jedoch nur der Einsatz der Maildir-Formate.
	</para>
	<para>
	  Andere SMTP-Server wie Exim beherrschen die Auslieferung in Maildirs
	  entweder von Haus aus oder es existieren entsprechende Patches. Ist
	  beides nicht möglich, kann zur lokalen Auslieferung von Emails entweder
	  <literal>maildrop</literal> oder <literal>deliverquota</literal>
	  verwendet werden.
	</para>
	<para>
	  Für das Anlegen von Maildirs wird das Courier-Programm
	  <literal>maildirmake</literal> empfohlen, 
	</para>
	<programlisting>
maildirmake /home/racke/Maildir
	</programlisting>
	<section>
	  <title>Quotas</title>
	  <para>Die bevorzugte Methode, um Platzbeschränkungen (Quotas) auf
		Benutzerpostfächer zu erzwingen, sind 
		Quotas pro Benutzer, basierend auf dem Dateisystem 
		(<ulink url="http://www.tldp.org/HOWTO/Quota.html" />). 
	  </para>
	  <para>Diese Lösung ist
		offensichtlich ungeeignet für virtuelle Postfächer, wo viele
		Postfächer die gleiche Benutzerkennung verwenden. Für diesen Fall
		kann der Speicherplatz in Maildir++-Postfächer durch sogenannte
		freiwillige Quotas eingeschränkt werden. Diese funktionieren
		jedoch nur, wenn alle  Anwendungen, die Emails in
		diese Postfächer ausliefern, sich an diese Konvention halten.
		Außerdem dürfen die Benutzer keinen direkten Zugriff auf das
		Dateisystem haben, ansonsten können sie die Beschränkungen einfach
		umgehen.
	  </para>
	  <para>
		Beim Anlegen eines Maildir++-Postfachs kann die Quota mit 
		der Kommandozeilenoption <literal>-q</literal> des
		<literal>maildirmake</literal>-Kommandos eingerichtet werden:
	  </para>
	  <programlisting>
maildirmake -q 1000000S /var/local/mail/linuxia.de/racke
	  </programlisting>
	 </section>
	<section><title>Interne Struktur</title></section>
	<para>Das Verzeichnis <filename>courierimapkeywords</filename> enthält die
	  Schlagwörter für die Emails in einem Maildir++-Ordner. Diese können
	  mit <literal>maildirkw -L .</literal> angezeigt werden.
	</para>
</section>

<section id="auth">
	<title>Authentifizierung</title>
	<para>
	  Die Authentifizierung für die einzelnen Komponenten wird durch 
	  Authentifizierungsmodule realisiert. Dabei wird die Authentifizierung 
	  durch die folgenden beiden Aufgaben charakterisiert:
	</para>
	<orderedlist>
	  <listitem><para>Zu einer Emailadresse das lokale Benutzerkonto mit
		  Heimatverzeichnis, Benutzerkennung (UID) und Gruppenkennung (GID)
		  bestimmen.</para></listitem>
	  <listitem><para>Zu einem Benutzername und einem Passwort das 
		  lokale Benutzerkonto mit
		  Heimatverzeichnis, Benutzerkennung (UID) und Gruppenkennung (GID)
		  bestimmen
		</para></listitem>
	</orderedlist>
	<para>
	  In den Konfigurationsdateien der einzelnen Dienste können die
	  gewünschten Authentifizierungsmodule angegeben werden. Dabei
	  werden die Module nacheinander durchlaufen. Signalisiert eines
	  der Module eine erfolgreiche Authentifizierung, steht der Dienst
	  dem Benutzer zur Verfügung. Dieses Daisy-Chaining erlaubt z.B.
	  PAM-Authentifizierung für Systembenutzer und Authentifizierung
	  gegen eine MySQL-Datenbank für virtuelle Mailkonten ohne
	  Systembenutzer.
	</para>
	<para>
	  Die wichtigsten Authentifizierungsmodule neben dem 
	  Authentifizierungsdämon (authdaemon) sind:
	</para>

	<variablelist>
	  <varlistentry><term>authpam</term>
		<listitem><para>PAM-Authentifizierung</para></listitem>
	  </varlistentry>
	  <varlistentry><term>authuserdb</term>
		<listitem><para>Authentifizierung anhand einer Unix-Datenbank (GDBM
			oder DB)</para></listitem>
	  </varlistentry>
	  <varlistentry><term>authmysql</term>
		<listitem><para>Authentifizierung anhand einer MySQL-Datenbank</para></listitem>
	  </varlistentry>
	  <varlistentry><term>authpgsql</term>
		<listitem><para>Authentifizierung anhand einer PostgreSQL-Datenbank</para></listitem>
	  </varlistentry>
	  <varlistentry><term>authldap</term>
		<listitem><para>Authentifizierung anhand eines LDAP-Verzeichnisses</para></listitem>
	  </varlistentry>
	  <varlistentry><term>authvchkpw</term>
		<listitem><para>Authentifizierung anhand von virtuelle Domains von vpopmail</para></listitem>
	  </varlistentry>
	</variablelist>  
	<para>Der Authentifizierungsdämon ist ein als Dämon laufender Proxy, der
	  dauerhafte Verbindungen zu der Authentifizierungsdatenbank herstellt
	  und dadurch eine deutliche schneller Authentifizierung ermöglicht, 
	  als mit den oben genannten Authentifizierungsmodulen. authdaemon
	  kann ebenfalls mehrere Authentifizierungsmodule nacheinander befragen.
	</para>
</section>

<section id="sharedfolders">
	<title>Gemeinsame Ordner</title>
	<para>Courier-IMAP und SqWebMail können zwei Typen von gemeinsamen Ordner
	  (shared folders) verwenden: 
	</para>
	<orderedlist>
	  <listitem><para>Basierend auf Dateizugriffsrechten, für Systeme mit
		  traditionellen Shellbenutzerkonten</para></listitem>
	  <listitem><para>Virtuelle gemeinsame Ordner, für geschlossene Systeme mit
		  gemeinsamen Benutzer- und Gruppenkennungen</para></listitem>		
	</orderedlist>
	<para>
	  Virtuelle gemeinsame Ordner basieren auf Zugangskontrollisten (ACL),
	  die nicht dem gleichnamigen Dateisystem-ACL verwechselt werden sollten.
	  Jeder Benutzer kann einem anderen Benutzer oder einer anderen
	  Benutzergruppen den Zugriff auf einen Ordner gewähren. Durch die
	  Zugangskontrollisten ist ein fein abgestufte Kontrolle der Zugriffsrechte
	  möglich.
	</para>
</section>

<section>
	<title>SMTP-Server (Courier)</title>
	<para>
	  Die Konfiguration des SMTP-Servers erfolgt über eine Anzahl von
	  Konfigurationsdateien, die sich in einem Verzeichnis befinden.
	  Wir werden als Konfigurationsverzeichnis, auch für die anderen
	  Komponenten, <filename>/etc/courier</filename> verwenden.
	</para>
	<para>
	  Einige Konfigurationsdateien können anstatt als einfache Textdatei 
	  auch als Sammlung von Textdateien in einem Unterverzeichnis von
	  <filename>/etc/courier</filename> zur Verfügung gestellt werden.
	  Dies ist sogar erforderlich, wenn man das Web-Administrationsfrontend
	  verwenden möchte.
	</para>
<section>
	  <title>Aliase</title>
	<para>
	  Systemaliase können z.B. in
	  <filename>/etc/courier/aliases/system</filename> 
	  abgelegt werden:
	</para>	  
	<programlisting>
root: postmaster
mailer-daemon: postmaster
MAILER-DAEMON: postmaster
postmaster: racke
	</programlisting>
	  <para>
		Nach Änderungen ist das Programm <literal>makealiases</literal>
		aufzurufen.
	  </para>
</section>
<section>
	  <title>MIME-Konformität</title>
	  <para>
		Emails, die nicht den MIME-Konventionen entsprechen, können vom
		Courier-Mailserver akzeptiert, als nicht auslieferbar zurückgeschickt
		werden oder als Attachment an den Empfänger weitergeleitet werden.
		Diese Emails nicht zu akzeptieren ist bei der minderen Qualität vieler
		Emailclients oft problematisch. Die Prüfung kann in der Datei
		<filename>/etc/courier/bofh</filename> deaktiviert werden:
	  </para>
		<programlisting>
opt BOFHBADMIME=accept		 
		</programlisting>
</section>
<section>
	  <title>Mailfilter</title>
	  <para>
	  Courier stellt zwei verschiedene Mechanismem zur Filterung von Emails zur
	  Verfügung, globale und lokale Mailfilter.
	  </para>
	  <para>
		Globale Mailfilter sind im Hintergrund laufende Dämonen, die jede
		eingehende Email filtern. Sie können nicht die Email selbst
		verändern. </para>
	  <para>
		Lokale Mailfilter filtern Emails an lokale Benutzer, die eigene
		Filterregeln verwenden können. Dies wird gewöhnlich von Maildrop
		erledigt.
		</para>	
</section>
</section>

<section>
	<title>IMAP-Server (Courier-IMAP)</title>
	<para>
	  Neben den Features, die sich durch das 
	  <link linkend="framework">Courier-Framework</link> ergeben,
	  zeichnet sich Courier-IMAP u.a. durch geringen Speicherverbrauch,
	  und Unterstützung verschiedener IMAP-Erweiterungen aus:
	</para>

	<itemizedlist>
	  <listitem><para>serverseitiges Sortieren und Threading</para></listitem>
	  <listitem><para>IMAP Schlagwörter</para></listitem>
	</itemizedlist>
	
	<section>
	  <title>Namespaces</title>
	  <para>
		...
	  </para>
	</section>

	<section>
	  <title>Typische Probleme</title>
	  <para>Einige moderne IMAP-Clients öffnen für
		jeden Ordner eine Verbindung zum IMAP-Server. Bei einer konservativen
		Einstellung für <literal>MAXPERIP</literal> wie die Voreinstellung 4
		stehen schnell zu wenig Verbindungen zur Verfügung. Das kann z.B. dazu
		führen, daß der IMAP-Client einen leeren Ordner anzeigt. Sicherlich ist
		das als Bug des Clients zu werten, führt beim Anwender doch zu
		erheblicher Verwirrung.
	  </para>
	</section>
	<section>
	  <title>Konfiguration</title>
	  <para>Ausgewählte Konfigurationsvariablen aus
		<filename>/etc/courier/imapd</filename>:
	  </para>
	  <table>
		<title>IMAP-Konfiguration</title>
		<tgroup cols="2">
		  <thead>
			<row>
			  <entry>Variable</entry>
			  <entry>Beschreibung</entry>
			  <entry>Standardwert</entry>
			</row>
		  </thead>
		  <tbody>
			<row>
			  <entry>MAXDAEMONS</entry>
			  <entry>maximale Anzahl der IMAP-Server</entry>
			  <entry>40</entry>
			</row>
			<row>
			  <entry>MAXPERIP</entry>
			  <entry>maximale Anzahl der von einer IP-Adresse
				ausgehenden Verbindungen 
				  (u.U. mehrere pro IMAP-Client !)</entry>
			  <entry>4</entry>
			</row>
			<row>
			  <entry>IMAP_KEYWORDS</entry>
			  <entry>IMAP-Schlagworte</entry>
			  <entry>1</entry>
			</row>
			<row>
			  <entry>IMAP_ULIMITD</entry>
			  <entry>maximale Größe des Datensegments des
				Serverprozesses (Schutzmaßnahme gegen Speicherlecks)</entry>
			  <entry>65536</entry>
			</row>
			</tbody>
		  </tgroup>
		</table>
	</section>
</section>

<section>
	<title>Maildrop</title>
	<para>
	  Maildrop wird zur Filterung und lokalen Auslieferung von Emails
	  verwendet.
	</para>
	<para>
	  Folgendes einfache Beispiel illustriert die Filterung mit einem
	  externen Programm:
	</para>
	<programlisting>
import VDIR

# Send everything smaller than 256 KB to Spamassassin
if ($SIZE &lt; 262144)
{
	xfilter "/usr/bin/spamc -U /var/run/spamd.sock"

	if (/^X-Spam-Status: Yes/:h)
	{
    	exception {
	       to "$VDIR/.SPAM/."
    	}
	}	
}

to "$VDIR/."	  
	</programlisting>
</section>

<section>
	<title>SqWebMail</title>
	<para>
	  Die Webmailvariante aus dem Courierpaket nennt sich SqWebMail und besteht
	  aus einem minimalen CGI-Programm und einem Dämon für die Auslieferung der
	  eigentlichen HTML-Seiten.
	</para>
	<para>
	</para>
	<para>
	  Im Gegensatz zu vielen anderen Webmailer arbeitet SqWebMail auf der
	  Dateisystemebene und verbindet sich nicht mit einem vorhandenen POP-
	  bzw. IMAP-Server. Häufig wird SqWebMail aber durch eine solche Lösung
	  ersetzt.
	</para>
	<section><title>Kalender</title>
	  <para>Die Kalenderfunktionen werden in der Konfigurationsdatei 
		<file>calendarmode</file> festgelegt. 
		Diese sind aktiviert, wenn die Datei die Werte <literal>local</literal>
		(lokaler Modus) oder <literal>net</literal> (Groupware-Modus) enthält.
	  </para>
	</section>
</section>

<section>
	<title>couriermlm</title>
	<para>
	  Auf den Mailinglistenserver aus dem Courierpaket möchte ich an dieser
	  Stelle nicht weiter eingehen, da er eher geringe Verbreitung erfahren
	  hat. Statt couriermlm können Alternativen wie Sympa oder Mailman
	  eingesetzt werden.
	</para>
  </section>
  
<section id="ssl">
	<title>SSL/TLS</title>
	<para>
	  Alle relevanten Komponenten des Courier-Mailservers erlauben die
	  Abwicklung über mit SSL/TLS geschützten Verbindungen. Dies geschieht
	  entweder über direkt über einen speziellen Port (465 für SMTP,
	  993 für IMAP und 995 für POP3) oder über die STARTTLS-Erweiterung
	  der jeweiligen Protokolle.
	</para>
	<para>
	  Durch Einsatz eines speziellen SSL/TLS-Wrappers
	  (<literal>couriertls</literal>) werden keine gesonderten Programme
	  benötigt, sondern es können dieselben wie für ungeschützte Verbindungen
	  verwendet werden.
	</para>
</section>

<section>
	<title>Installation</title>
	<para>
	  Die Installation von Courier kann direkt aus den Sourcen erfolgen
	  oder es können Debian- bzw. RPM-Pakete verwendet werden.
	</para>
	<para>
	  Die Installation aus den Sourcen wird umfangreich im
	  <filename>INSTALL</filename>-Dokument beschrieben, daß im
	  Quellarchive vorhanden ist bzw. online verfügbar ist.
	 </para>
	<para>
	  Zusätzlich zu den typischen Befehlen zur Kompilierung und Installation
	  eines Open-Source-Pakets werden im letzten Schritt die
	  Konfigurationsdateien installiert bzw. aktualisiert:
	</para>
	  <programlisting>
./configure
make
make install
make install-configure
	  </programlisting>
</section>
	
<section>
	<title>Weitere Informationen</title>
	<variablelist>
	  <varlistentry><term><ulink url="http://www.courier-mta.org/" /></term>
		<listitem><para>Courier Homepage</para></listitem>
	  </varlistentry>	  
	  <varlistentry><term><ulink url="http://lists.sourceforge.net/mailman/listinfo/courier-users">courier-users</ulink></term>
		<listitem><para>Allgemeine Mailingliste für Courierbenutzer</para></listitem>
	  </varlistentry>	  
	  <varlistentry><term><ulink url="http://lists.sourceforge.net/mailman/listinfo/courier-announce">courier-announce</ulink></term>
		<listitem><para>Ankündigungen zum Courier-Mailserver</para></listitem>
	  </varlistentry>	  
	</variablelist>
	<section>
	  <title>RFCs</title>
	  <table><title>RFCs</title>
		<tgroup cols="3">
		  <tbody>
			<row>
			  <entry>2095</entry><entry>Authentication</entry><entry>CRAM-MD5</entry>
			</row>
			<row>
			  <entry>2342</entry><entry>IMAP</entry><entry>NAMESPACE</entry>
			</row>
			<row>
			  <entry>2595</entry><entry>SSL/TLS</entry><entry>STARTTLS</entry>
			</row>
		  </tbody>
		</tgroup>
	  </table>
	</section>
</section>

</article>
