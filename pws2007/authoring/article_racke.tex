%% -*- mode: latex; -*-

\section{Spamassassin, Antivirus und Email via Perl}

\subsection*{Autor}
Stefan Hornburg (Racke) \verb/<racke@linuxia.de>/

\subsection*{Bio Stefan Hornburg}

\subsection*{Abstract}
Die Bedeutung von Email für die Kommunikation hat einen hohen
Stellenwert erreicht und ist oftmals nicht aus dem täglichen
Leben und aus der Arbeitswelt wegzudenken. Attacken auf dieses
wichtige Instrument mittlels SPAM, Viren und Phishing nehmen
kontinuierlich zu. Nützliche Emails drohen in einer Flut von unerwünschter
und potentiell schädlichen Post unterzugehen, wenn Gegenmaßnahmen
nicht oder nur unzureichend greifen.

Für Perl sind eine Reihe von Modulen vorhanden, die die Erstellung
von Programmen zum Zugriff auf Email und die Bewertung der Email
erleichtern:

	Net::SMTP (Emailversand)
	Mail::IMAPClient (Zugriff auf Email mit IMAP)
	Mail::Spamassassin (Spamassassin)
	ClamAV::Client (Clam Antivirus)
	
Nach einer kurzen Einführung in die Benutzung dieser Module beschäftigt
sich der Hauptteil des Vortrags mit der Beschreibung von Anwendungen
zur Verbesserung der Abwehr von SPAM, Viren und Phishing.

Zur Demonstration werden Emails von einem IMAP-Server heruntergeladen 
und von ClamAV auf Viren und Phishing geprüft und anschließend durch
SpamAssassin bewertet. Anschließend wird gezeigt, wie diese Emails vom
Server gelöscht oder in bestimmte Verzeichnisse auf dem IMAP-Server verschoben
werden können. Die Behandlung von Fehlerkennungen (False Positives)
wird ebenso erläutert.

Im Anschluß wird die Erstellung von Statistiken über das Aufkommen
von Viren und SPAM besprochen und wie man daraus Schlüsse zur Optimierung
zur Abwehr treffen kann.

\subsection{Mailversand mit Net::SMTP}
\begin{verbatim}
use Net::SMTP;

my $smtp = new Net::SMTP;
\end{verbatim}

\subsection{Mailempfang mit Mail::IMAPClient}

Eine IMAP-Verbindung kann einfach durch die Erzeugung eines
\verb/Mail::IMAPClient/-Objektes
mit den geeigneten Parametern hergestellt werden. Dafür müssen
zumindestens der Servername (Server), Benutzername (User) und Passwort
(Password) übergeben werden. Dann erfolgt der Verbindungsaufbau und die
Anmeldung automatisch.

\begin{verbatim}
use Mail::IMAPClient;

my $params = (Server => $server,
              User => $login,
              Password => $password);

my $client = new Mail::IMAPClient (%params);
\end{verbatim}

Dies ist nicht moeglich, wenn man eine SSL-geschützte Verbindung aufbauen
moechte. In diesem Fall erzeugt man die Verbindung mit dem
\verb/IO::Socket::SSL/-Modul: 

\begin{verbatim}
use IO::Socket::SSL;
use Mail::IMAPClient;

my $conn;

unless ($conn = new IO::Socket::SSL->new ("${server}:imaps")) {
    die "$0: imaps connection to $server failed: $!\n";
}

$imap = new Mail::IMAPClient (Socket => $conn,
							  User => $user,
							  Password => $password);
\end{verbatim}

Unbekannte Methoden werden direkt in IMAP-Befehle umgesetzt.

\subsection{Virenscanner mit ClamAV::Client}
Das Modul \WSIndex{ClamAV::Client} bietet eine Schnittstelle zum ClamAV
Virenscanner. Beim Anlegen des Objektes wird eine Verbindung zum 
\verb/clamd/-Daemon aufgebaut.
\begin{verbatim}
use ClamAV::Client;

my $scanner;

$scanner = new ClamAV::Client;

unless (defined $scanner && $scanner->ping()) {
	die "$0: connection to ClamAV daemon failed\n";
}
\end{verbatim}
Mit den Parametern \verb/socket_name/, \verb/socket_host/,
\verb/socket_port/ wird die Art der Verbindung (TCP oder Unixsocket)
und die Verbindungsparameter definiert.

Mit Hilfe der \verb/version/-Methode kann man bestimmen, ob die Virusengine
und die Virusdatenbank von ClamAV auf dem neuesten Stand ist:

\begin{verbatim}
\end{verbatim}

\subsection{Spamfilter mit Mail::Spamassassin}
Eine Email kann wie folgt mit \WSIndex{Mail::Spamassassin} untersucht werden:

\begin{verbatim}
# initiate Spamassassin object
$sa = new Mail::SpamAssassin;
# retrieve a message from the IMAP server
$message = $imap->message_string($msgno);
# let SpamAssassin parse the message
$samsg = $sa->parse($message);
$status = $sa->check($samsg);
# score and matched rules
$sascore = $status->get_hits();

# SPAM or HAM 
\end{verbatim}

\subsection{Scenarios}
\subsubsection{Bayes}
Update Bayes from FN/FP.
Die Emaildateien koennten auch direkt aus dem Dateisystem gelesen werden,
aber bei Zugriff mit IMAP brauchen wir keine Annahmen ueber die 
Verzeichnisstruktur zu machen bzw. koennen Mailserver und SA-Server auf
verschiedenen Rechnern sein.

Problem: verbraucht viel RAM

\subsubsection{Virus}
Mit einer lokalen Installation von ClamAV koennen Postfaecher auf anderen
Servern auf Malware untersucht werden.

Selbst bei einem geschuetzten 
Scan mails on remote server and delete them

\subsubsection{Spamassassin}
Scan mails on remote server and move them, idea: better SPAM fighting
from local machine, especially on new waves.

\subsection{Emails loeschen oder verschieben}

Das Loeschen von Emails auf einen IMAP-Server kann man nicht mit dem
Loeschen einer Datei auf einem Linux-System vergleichen. Emails werden
zunaechst nur zum Loeschen markiert. 

Die \verb/delete_message/-Methode fuehrt das folgende IMAP-Kommando aus:
\verb/UID store 3,4,5,6,7 +FLAGS.SILENT (\Deleted)/. Die Emails sind
weiterhin sichtbar. Erst durch das Schliessen des IMAP-Ordners oder
dem expliziten \verb/expunge/ werden die Emails physikalisch geloescht.

\begin{thebibliography}{99}

\end{thebibliography}

